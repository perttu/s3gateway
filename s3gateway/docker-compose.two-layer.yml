version: '3.8'

services:
  # Global Database - Provider registry and routing information
  postgres-global:
    image: postgres:15
    container_name: s3gateway_postgres_global
    environment:
      POSTGRES_DB: s3gateway_global
      POSTGRES_USER: s3gateway
      POSTGRES_PASSWORD: s3gateway_pass
    ports:
      - "5432:5432"  # Global database port
    volumes:
      - postgres_global_data:/var/lib/postgresql/data
      - ./code/gateway/schema_global.sql:/docker-entrypoint-initdb.d/schema_global.sql
    networks:
      - s3gateway_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U s3gateway -d s3gateway_global"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Regional Database - FI-HEL region (customer object metadata)
  postgres-fi-hel:
    image: postgres:15
    container_name: s3gateway_postgres_fi_hel
    environment:
      POSTGRES_DB: s3gateway_regional
      POSTGRES_USER: s3gateway
      POSTGRES_PASSWORD: s3gateway_pass
    ports:
      - "5433:5432"  # Regional database port
    volumes:
      - postgres_fi_hel_data:/var/lib/postgresql/data
      - ./code/gateway/schema_regional.sql:/docker-entrypoint-initdb.d/schema_regional.sql
    networks:
      - s3gateway_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U s3gateway -d s3gateway_regional"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Regional Database - DE-FRA region (for future expansion)
  postgres-de-fra:
    image: postgres:15
    container_name: s3gateway_postgres_de_fra
    environment:
      POSTGRES_DB: s3gateway_regional
      POSTGRES_USER: s3gateway
      POSTGRES_PASSWORD: s3gateway_pass
    ports:
      - "5434:5432"  # Regional database port
    volumes:
      - postgres_de_fra_data:/var/lib/postgresql/data
      - ./code/gateway/schema_regional.sql:/docker-entrypoint-initdb.d/schema_regional.sql
    networks:
      - s3gateway_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U s3gateway -d s3gateway_regional"]
      interval: 10s
      timeout: 5s
      retries: 5

  # S3Proxy (for fallback/testing)
  s3proxy:
    build: ./docker/s3proxy
    container_name: s3gateway_s3proxy
    ports:
      - "8080:8080"
    volumes:
      - s3proxy_data:/app/data
    networks:
      - s3gateway_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Global Gateway - Handles routing and provider management
  gateway-global:
    build:
      context: ./code/gateway
      dockerfile: Dockerfile
    container_name: s3gateway_global
    environment:
      DATABASE_URL: postgresql://s3gateway:s3gateway_pass@postgres-global:5432/s3gateway_global
      GATEWAY_TYPE: global
      REGIONAL_ENDPOINTS: '{"FI-HEL": "http://gateway-fi-hel:8000", "DE-FRA": "http://gateway-de-fra:8000"}'
      S3PROXY_URL: http://s3proxy:8080
    ports:
      - "8000:8000"  # Global endpoint
    networks:
      - s3gateway_network
    depends_on:
      postgres-global:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Regional Gateway - FI-HEL region
  gateway-fi-hel:
    build:
      context: ./code/gateway
      dockerfile: Dockerfile
    container_name: s3gateway_fi_hel
    environment:
      DATABASE_URL: postgresql://s3gateway:s3gateway_pass@postgres-fi-hel:5432/s3gateway_regional
      GLOBAL_DATABASE_URL: postgresql://s3gateway:s3gateway_pass@postgres-global:5432/s3gateway_global
      GATEWAY_TYPE: regional
      REGION_ID: FI-HEL
      S3_BACKENDS_CONFIG: /app/config/s3_backends_fi_hel.json
      PROVIDERS_FILE: /app/providers_flat.csv
      S3PROXY_URL: http://s3proxy:8080
    volumes:
      - ./providers_flat.csv:/app/providers_flat.csv
      - ./config/s3_backends.json:/app/config/s3_backends_fi_hel.json
    ports:
      - "8001:8000"  # Regional endpoint FI-HEL
    networks:
      - s3gateway_network
    depends_on:
      postgres-fi-hel:
        condition: service_healthy
      postgres-global:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Regional Gateway - DE-FRA region (for future expansion)
  gateway-de-fra:
    build:
      context: ./code/gateway
      dockerfile: Dockerfile
    container_name: s3gateway_de_fra
    environment:
      DATABASE_URL: postgresql://s3gateway:s3gateway_pass@postgres-de-fra:5432/s3gateway_regional
      GLOBAL_DATABASE_URL: postgresql://s3gateway:s3gateway_pass@postgres-global:5432/s3gateway_global
      GATEWAY_TYPE: regional
      REGION_ID: DE-FRA
      S3_BACKENDS_CONFIG: /app/config/s3_backends_de_fra.json
      PROVIDERS_FILE: /app/providers_flat.csv
      S3PROXY_URL: http://s3proxy:8080
    volumes:
      - ./providers_flat.csv:/app/providers_flat.csv
      - ./config/s3_backends.json:/app/config/s3_backends_de_fra.json
    ports:
      - "8002:8000"  # Regional endpoint DE-FRA
    networks:
      - s3gateway_network
    depends_on:
      postgres-de-fra:
        condition: service_healthy
      postgres-global:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_global_data:
  postgres_fi_hel_data:
  postgres_de_fra_data:
  s3proxy_data:

networks:
  s3gateway_network:
    driver: bridge

# Usage Instructions:
#
# 1. Start all services:
#    docker-compose -f docker-compose.two-layer.yml up -d
#
# 2. Global endpoint (routes to regional endpoints):
#    http://localhost:8000
#
# 3. Regional endpoints (direct access):
#    FI-HEL: http://localhost:8001
#    DE-FRA: http://localhost:8002
#
# 4. Test routing:
#    # Global endpoint determines region based on customer_id
#    curl -H "X-Customer-ID: demo-customer" http://localhost:8000/s3/bucket/object
#    
#    # Direct regional access
#    curl http://localhost:8001/s3/bucket/object
#
# 5. Check databases:
#    # Global database
#    docker exec -it s3gateway_postgres_global psql -U s3gateway -d s3gateway_global
#    
#    # Regional database (FI-HEL)
#    docker exec -it s3gateway_postgres_fi_hel psql -U s3gateway -d s3gateway_regional 