version: '3.8'

services:
  # GDPR-Compliant Global Database - Provider registry and routing information ONLY
  postgres-global:
    image: postgres:15
    container_name: s3gateway_postgres_global_gdpr
    environment:
      POSTGRES_DB: s3gateway_global
      POSTGRES_USER: s3gateway
      POSTGRES_PASSWORD: s3gateway_pass
    ports:
      - "5432:5432"  # Global database port
    volumes:
      - postgres_global_data:/var/lib/postgresql/data
      - ./code/gateway/schema_global_gdpr.sql:/docker-entrypoint-initdb.d/schema_global_gdpr.sql
    networks:
      - s3gateway_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U s3gateway -d s3gateway_global"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Regional Database - FI-HEL region (customer object metadata)
  postgres-fi-hel:
    image: postgres:15
    container_name: s3gateway_postgres_fi_hel_gdpr
    environment:
      POSTGRES_DB: s3gateway_regional
      POSTGRES_USER: s3gateway
      POSTGRES_PASSWORD: s3gateway_pass
    ports:
      - "5433:5432"  # Regional database port
    volumes:
      - postgres_fi_hel_data:/var/lib/postgresql/data
      - ./code/gateway/schema_regional.sql:/docker-entrypoint-initdb.d/schema_regional.sql
    networks:
      - s3gateway_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U s3gateway -d s3gateway_regional"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Regional Database - DE-FRA region (for future expansion)
  postgres-de-fra:
    image: postgres:15
    container_name: s3gateway_postgres_de_fra_gdpr
    environment:
      POSTGRES_DB: s3gateway_regional
      POSTGRES_USER: s3gateway
      POSTGRES_PASSWORD: s3gateway_pass
    ports:
      - "5434:5432"  # Regional database port
    volumes:
      - postgres_de_fra_data:/var/lib/postgresql/data
      - ./code/gateway/schema_regional.sql:/docker-entrypoint-initdb.d/schema_regional.sql
    networks:
      - s3gateway_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U s3gateway -d s3gateway_regional"]
      interval: 10s
      timeout: 5s
      retries: 5

  # S3Proxy (for fallback/testing)
  s3proxy:
    build: ./docker/s3proxy
    container_name: s3gateway_s3proxy_gdpr
    ports:
      - "8080:8080"
    volumes:
      - s3proxy_data:/app/data
    networks:
      - s3gateway_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # GDPR-Compliant Global Gateway - Uses HTTP redirects instead of proxying
  gateway-global:
    build:
      context: ./docker/gateway
      dockerfile: Dockerfile
    container_name: s3gateway_global_gdpr
    environment:
      DATABASE_URL: postgresql://s3gateway:s3gateway_pass@postgres-global:5432/s3gateway_global
      GATEWAY_TYPE: global
      REGIONAL_ENDPOINTS: '{"FI-HEL": "http://localhost:8001", "DE-FRA": "http://localhost:8002"}'
      ENABLE_GDPR_REDIRECTS: "true"  # Enable GDPR-compliant redirects
      S3PROXY_URL: http://s3proxy:8080
    volumes:
      - ./code/gateway/main_gdpr_compliant.py:/app/main.py
      - ./providers_flat.csv:/app/providers_flat.csv
    ports:
      - "8000:8000"  # Global endpoint
    networks:
      - s3gateway_network
    depends_on:
      postgres-global:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Regional Gateway - FI-HEL region (GDPR-compliant)
  gateway-fi-hel:
    build:
      context: ./docker/gateway
      dockerfile: Dockerfile
    container_name: s3gateway_fi_hel_gdpr
    environment:
      DATABASE_URL: postgresql://s3gateway:s3gateway_pass@postgres-fi-hel:5432/s3gateway_regional
      GLOBAL_DATABASE_URL: postgresql://s3gateway:s3gateway_pass@postgres-global:5432/s3gateway_global
      GATEWAY_TYPE: regional
      REGION_ID: FI-HEL
      S3_BACKENDS_CONFIG: /app/config/s3_backends_fi_hel.json
      PROVIDERS_FILE: /app/providers_flat.csv
      S3PROXY_URL: http://s3proxy:8080
    volumes:
      - ./code/gateway/main_gdpr_compliant.py:/app/main.py
      - ./providers_flat.csv:/app/providers_flat.csv
      - ./config/s3_backends.json:/app/config/s3_backends_fi_hel.json
    ports:
      - "8001:8000"  # Regional endpoint FI-HEL
    networks:
      - s3gateway_network
    depends_on:
      postgres-fi-hel:
        condition: service_healthy
      postgres-global:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Regional Gateway - DE-FRA region (GDPR-compliant)
  gateway-de-fra:
    build:
      context: ./docker/gateway
      dockerfile: Dockerfile
    container_name: s3gateway_de_fra_gdpr
    environment:
      DATABASE_URL: postgresql://s3gateway:s3gateway_pass@postgres-de-fra:5432/s3gateway_regional
      GLOBAL_DATABASE_URL: postgresql://s3gateway:s3gateway_pass@postgres-global:5432/s3gateway_global
      GATEWAY_TYPE: regional
      REGION_ID: DE-FRA
      S3_BACKENDS_CONFIG: /app/config/s3_backends_de_fra.json
      PROVIDERS_FILE: /app/providers_flat.csv
      S3PROXY_URL: http://s3proxy:8080
    volumes:
      - ./code/gateway/main_gdpr_compliant.py:/app/main.py
      - ./providers_flat.csv:/app/providers_flat.csv
      - ./config/s3_backends.json:/app/config/s3_backends_de_fra.json
    ports:
      - "8002:8000"  # Regional endpoint DE-FRA
    networks:
      - s3gateway_network
    depends_on:
      postgres-de-fra:
        condition: service_healthy
      postgres-global:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_global_data:
  postgres_fi_hel_data:
  postgres_de_fra_data:
  s3proxy_data:

networks:
  s3gateway_network:
    driver: bridge

# GDPR Compliance Features:
#
# 1. HTTP Redirects Instead of Proxying:
#    - Customer data goes directly to regional endpoints
#    - Global gateway never sees customer requests/responses
#    - No "man in the middle" GDPR violations
#
# 2. Minimal Global Logging:
#    - NO IP addresses stored globally
#    - NO user agents or request details
#    - Only customer ID and routing decisions
#
# 3. Regional Data Sovereignty:
#    - Finnish customer data stays in FI-HEL
#    - German customer data stays in DE-FRA
#    - Complete isolation of customer personal data
#
# 4. Audit Trail Compliance:
#    - Full audit trails in regional databases
#    - Minimal operational logs globally
#    - GDPR-compliant data retention
#
# Usage Examples:
#
# 1. Customer makes request to global endpoint:
#    curl -H "X-Customer-ID: finnish-customer" http://localhost:8000/s3/bucket
#    → Gets HTTP 307 redirect to http://localhost:8001/s3/bucket
#    → Browser/client follows redirect directly to FI-HEL region
#
# 2. Check GDPR compliance:
#    curl http://localhost:8000/compliance/audit  # Global minimal data
#    curl http://localhost:8001/api/compliance/audit  # Regional full data
#
# 3. Verify redirect behavior:
#    curl -v -H "X-Customer-ID: test-customer" http://localhost:8000/s3/test
#    # Should return HTTP 307 with Location header pointing to regional endpoint 